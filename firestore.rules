/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict ownership model for user data and allows public read access to vehicle and gallery data with owner-only write access.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, accessible only to the user themselves.
 * - /vehicles/{vehicleId}: Stores vehicle inventory data, publicly readable, but writeable only by authenticated users.
 * - /gallery/{galleryItemId}: Stores customer gallery images and captions, publicly readable, but writeable only by authenticated users.
 *
 * Key Security Decisions:
 * - Users can only read and write their own data in the /users collection.
 * - Vehicle and gallery data is publicly readable but can only be modified by authenticated users.
 * - Data validation is minimal in this prototyping phase, focusing on ownership and relational integrity.
 *
 * Denormalization for Authorization:
 * - The rules do not currently require denormalization as they rely on path-based authorization for users and simple authentication checks for vehicles and gallery items.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) if the request is made by the user with the matching ID.
     * @deny (create, update, delete) if the request is made by a different user or an unauthenticated user.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to vehicle inventory data.
     * @path /vehicles/{vehicleId}
     * @allow (get, list) to anyone.
     * @allow (create) to only authenticated users. The 'make', 'model', 'year', 'price', 'status', 'description', 'features', 'imageUrl' fields in the request data are required.
     * @allow (update, delete) to authenticated users if the document exists.
     * @deny (create, update, delete) if the user is not authenticated.
     * @principle Allows public read access with authenticated-user-only write access.
     */
    match /vehicles/{vehicleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && exists(resource.data);
    }

    /**
     * @description Controls access to customer gallery images and captions.
     * @path /gallery/{galleryItemId}
     * @allow (get, list) to anyone.
     * @allow (create) to only authenticated users. The 'caption', 'imageUrl' fields in the request data are required.
     * @allow (update, delete) to authenticated users if the document exists.
     * @deny (create, update, delete) if the user is not authenticated.
     * @principle Allows public read access with authenticated-user-only write access.
     */
    match /gallery/{galleryItemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && exists(resource.data);
    }
  }
}