/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a public read, owner-only write model for vehicles, and gallery items. User data is private and only accessible to the owner.
 * @data_structure
 *  - /users/{userId}: Stores private user profile data.
 *  - /vehicles/{vehicleId}: Stores publicly-readable vehicle data, with owner-only modification rights.
 *  - /gallery/{galleryItemId}: Stores publicly-readable gallery data, with owner-only modification rights.
 * @key_security_decisions
 *  - Users can only read and write their own profile data.
 *  - Vehicle and Gallery Item data is readable by everyone, but only the owner can create, update, or delete it.  The application must ensure that the `request.auth.uid` is populated on create.
 * @denormalization_for_authorization
 *  - Vehicle documents should include an `ownerId` field, which is set to `request.auth.uid` upon creation and is immutable.
 *  - Gallery Item documents should include an `ownerId` field, which is set to `request.auth.uid` upon creation and is immutable.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants owner-only access to user profile data.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) User with matching {userId} can perform all operations.
     * @deny (get, create, update, delete, list) User with non-matching {userId} cannot perform any operations.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants public read access to vehicle data, but restricts writes to the owner.
     * @path /vehicles/{vehicleId}
     * @allow (get, list) Any user can read vehicle data.
     * @allow (create) Only the authenticated user can create a vehicle, and must set `ownerId` to their `uid`.
     * @allow (update, delete) Only the owner of the vehicle (where `ownerId == request.auth.uid`) can update or delete it, and the document must exist.
     * @deny (create) An unauthenticated user cannot create a vehicle.
     * @deny (update, delete) A non-owner cannot update or delete a vehicle.
     * @principle Enforces public read, owner-only write for vehicle data.
     */
    match /vehicles/{vehicleId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Grants public read access to gallery item data, but restricts writes to the owner.
     * @path /gallery/{galleryItemId}
     * @allow (get, list) Any user can read gallery item data.
     * @allow (create) Only the authenticated user can create a gallery item, and must set `ownerId` to their `uid`.
     * @allow (update, delete) Only the owner of the gallery item (where `ownerId == request.auth.uid`) can update or delete it, and the document must exist.
     * @deny (create) An unauthenticated user cannot create a gallery item.
     * @deny (update, delete) A non-owner cannot update or delete a gallery item.
     * @principle Enforces public read, owner-only write for gallery item data.
     */
    match /gallery/{galleryItemId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      function isSignedIn() {
        return request.auth != null;
      }


      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }
  }
}