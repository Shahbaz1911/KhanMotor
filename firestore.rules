/**
 * @file Firestore Security Rules
 * @version 2
 *
 * @Core Philosophy
 * This ruleset prioritizes security by enforcing strict ownership for user data and public read access for vehicle and gallery data while ensuring only authenticated users can modify it.
 *
 * @Data Structure
 * - Users: User profiles are stored under `/users/{userId}`, accessible only to the authenticated user with matching UID.
 * - Vehicles: Vehicle inventory data is stored under `/vehicles/{vehicleId}`. It is publicly readable, but write access is restricted to authenticated users.
 * - Gallery: Customer gallery items are stored under `/gallery/{galleryItemId}`. It is publicly readable, but write access is restricted to authenticated users.
 *
 * @Key Security Decisions
 * - User data is strictly private; listing all users is disallowed.
 * - Public collections (`vehicles`, `gallery`) allow anyone to read but require authentication to modify.
 * - Data validation is relaxed in this prototype, focusing on ownership and relational integrity where critical.
 *
 * @Denormalization for Authorization
 *  -The current design already enforces ownership by requiring the `userId` in the path `/users/{userId}` to match the authenticated user's UID. For `vehicles` and `gallery`, the rules will check if the user is authenticated before allowing write operations.
 *
 * @Structural Segregation
 *  -Private user data is stored in a user-specific collection (`/users/{userId}`), while public data (`vehicles`, `gallery`) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profile data, allowing only the authenticated user to read and write their own profile.
     * @path /users/{userId}
     * @allow (get, create, update, delete) - Authenticated user with UID matching {userId}.
     * @deny (get, create, update, delete) - Any other user.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing all users is not permitted

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Manages vehicle inventory data, allowing public read access and authenticated write access.
     * @path /vehicles/{vehicleId}
     * @allow (get, list) - Any user (public read).
     * @allow (create, update, delete) - Authenticated users only.
     * @deny (create, update, delete) - Unauthenticated users.
     * @principle Allows public read access while enforcing authentication for writes.
     */
    match /vehicles/{vehicleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages customer gallery items, allowing public read access and authenticated write access.
     * @path /gallery/{galleryItemId}
     * @allow (get, list) - Any user (public read).
     * @allow (create, update, delete) - Authenticated users only.
     * @deny (create, update, delete) - Unauthenticated users.
     * @principle Allows public read access while enforcing authentication for writes.
     */
    match /gallery/{galleryItemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}